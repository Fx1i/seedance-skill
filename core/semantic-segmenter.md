# 智能语义分割算法

## 功能概述

基于智能语义分析，将剧情自动拆分成适合AI视频生成的片段，考虑15秒时长限制，同时保护叙事完整性。

## 核心原则

1. **基于语义分割**：理解剧情，而非简单按句子长度分割
2. **保护叙事完整性**：保持动作连贯性和故事逻辑
3. **智能时长分配**：基于动作复杂度动态调整
4. **尊重场景转换**：场景变化作为自然的分割点

## 分割策略

### 场景转换检测

**触发条件**：
- 地点描述变化
  - "她走进房间"
  - "从海滩来到森林"
  - 场景词汇变化（海边→城市）

- 时间跳跃标记
  - "第二天"
  - "一年后"
  - "傍晚时分"

- 角色切换
  - "与此同时，小明在..."
  - "另一边，..."
  - 多角色叙事切换

### 动作完整性保护

**保护原则**：
- 保持主要动作序列完整
  - 正确："她跑过去，打开门"（一个片段）
  - 错误："她跑过去" / "打开门"（破坏动作流）

- 避免在动作中途分割
  - 动作开始→进行→结束应在一个片段

- 保护因果关系
  - 因果动作应在一起
  - 正确："摔倒→哭泣"（一个片段）
  - 错误："摔倒" / "哭泣"（分割因果）

### 时长动态分配

**时长估算规则**：

```
简单动作：3-5秒
- 示例：坐下、转身、看
- 特点：单一动作，静态或简单动态

中等复杂：5-10秒
- 示例：对话、简单互动、走动
- 特点：涉及多个元素或简单动作序列

复杂场景：10-15秒
- 示例：追逐、战斗、复杂互动
- 特点：多个动作元素，动态性强

场景过渡：2-3秒
- 示例：场景转换、时间跳跃
- 特点：强调变化，短暂展示
```

**复杂度评估因素**：
1. 动作数量（单个vs多个）
2. 动作类型（静态vs动态）
3. 互动复杂度（无互动→简单互动→复杂互动）
4. 环境复杂度（单一环境→复杂环境）
5. 视觉元素数量

## 智能调整算法

### 步骤1：初始分割
```
基于语义单元进行初步分割：
- 按语义单元（动作、场景变化）
- 按自然段落
- 按时间跳跃点
```

### 步骤2：时长估算
```
为每个片段预估时长：
- 应用时长估算规则
- 考虑动作复杂度
- 评估视觉元素密度
```

### 步骤3：优化调整
```
针对超长片段（>15秒）：
- 检查是否可以拆分为更小语义单元
- 保持动作完整性前提下拆分
- 优先在自然停顿点分割

针对过短片段（<3秒）：
- 考虑合并相邻片段
- 如果合并不破坏叙事，则合并
- 保持片段时长合理（3-15秒）
```

### 步骤4：完整性检查
```
验证每个片段：
✓ 叙事逻辑完整
✓ 动作连贯性保持
✓ 时长在合理范围（3-15秒）
✓ 场景转换自然
✓ 情感表达清晰
```

## 分割决策树

```
开始
  ↓
检测场景变化？
  ├─ 是 → 创建新片段（场景转换，2-3秒）
  └─ 否 → 继续
      ↓
      检测复杂动作序列？
        ├─ 是 → 评估复杂度
        │         ├─ 高复杂度 → 单独片段（10-15秒）
        │         └─ 中等复杂度 → 检查时长
        │                    ├─ ≤15秒 → 单独片段
        │                    └─ >15秒 → 智能拆分
        └─ 否 → 检测简单动作
                  ├─ 是 → 合并相邻（5-10秒）
                  └─ 否 → 单独片段（3-5秒）
```

## 特殊情况处理

### 动作序列拆分
**问题**：长动作序列超过15秒
**解决**：
```
"她跑过街道，穿过人群，到达车站"（估计18秒）

优化方案：
片段1："她跑过街道"（5秒）
片段2："她穿过人群"（6秒）
片段3："她到达车站"（4秒）
```

### 对话场景
**问题**：对话场景如何分割
**解决**：
- 简单对话：一个片段（8-12秒）
- 复杂对话：按说话者或话题分段
- 对话+动作：分开处理

### 并行事件
**问题**："与此同时，小明在..."
**解决**：
- 作为单独片段处理
- 标记为"并行事件"
- 在时间线中标注与主事件的关系

## 输出格式

### 片段列表
```
片段 [编号]：
- 叙事内容：[剧情描述]
- 预估时长：[X]秒
- 复杂度：[简单/中等/复杂]
- 场景信息：[场景类型]
- 动作类型：[静态/动态]
- 备注：[特殊说明]
```

### 分割统计
```
分割结果：
- 总片段数：[X]个
- 总预估时长：[X]秒
- 平均片段时长：[X]秒
- 最长片段：[X]秒（片段编号）
- 最短片段：[X]秒（片段编号）
```

## 示例

### 输入
"一个女孩在海边看日落，然后转身跑回家"

### 处理过程

**步骤1：初始分割**
- 片段1："女孩在海边看日落"
- 片段2："转身跑回家"

**步骤2：时长估算**
- 片段1：静态观赏，简单动作 → 5秒
- 片段2：转身+跑，动态动作 → 6秒

**步骤3：优化调整**
- 片段1：5秒，符合范围 ✓
- 片段2：6秒，符合范围 ✓
- 无需调整

**步骤4：完整性检查**
- 片段1：叙事完整，时长合理 ✓
- 片段2：动作连贯，时长合理 ✓

### 输出
```
片段1：
- 叙事内容：女孩在海边看日落
- 预估时长：5秒
- 复杂度：简单
- 场景信息：海边
- 动作类型：静态
- 备注：观赏场景，营造氛围

片段2：
- 叙事内容：转身跑回家
- 预估时长：6秒
- 复杂度：中等
- 场景信息：海边→回家的路
- 动作类型：动态
- 备注：包含转身和跑两个动作

分割结果：
- 总片段数：2个
- 总预估时长：11秒
- 平均片段时长：5.5秒
- 最长片段：6秒（片段2）
- 最短片段：5秒（片段1）
```

## 注意事项

1. **保护叙事流畅性**：不要为了分割而破坏故事逻辑
2. **时长是参考值**：实际生成时可以根据需要微调
3. **灵活应用规则**：根据具体情况灵活运用分割策略
4. **保持简洁性**：避免过度分割，保持每个片段有明确目的
5. **视觉连贯性**：考虑片段间的视觉过渡